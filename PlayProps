package com.example.syslog.flow;

import io.opentelemetry.api.common.Attributes;
import io.opentelemetry.api.logs.LogRecordBuilder;
import io.opentelemetry.api.logs.Logger;
import io.opentelemetry.api.logs.Severity;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.ArgumentCaptor;
import org.mockito.Captor;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.integration.channel.DirectChannel;
import org.springframework.integration.dsl.IntegrationFlow;
import org.springframework.integration.dsl.StandardIntegrationFlow;
import org.springframework.integration.dsl.context.IntegrationFlowContext;
import org.springframework.integration.support.MessageBuilder;
import org.springframework.messaging.MessageChannel;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

/**
 * Unit tests for OutboundFlowOtelConfig.
 * Mocks the OTEL Logger to avoid network calls.
 */
@ExtendWith(MockitoExtension.class)
class OutboundFlowOtelConfigTest {

    @Mock
    private Logger otelLogger;

    @Mock
    private LogRecordBuilder logRecordBuilder;

    @Captor
    private ArgumentCaptor<String> bodyCaptor;

    @Captor
    private ArgumentCaptor<Severity> severityCaptor;

    @Captor
    private ArgumentCaptor<Attributes> attributesCaptor;

    private DirectChannel producerChannel;
    private IntegrationFlow flow;

    @BeforeEach
    void setUp() {
        // Setup mock chain
        when(otelLogger.logRecordBuilder()).thenReturn(logRecordBuilder);
        when(logRecordBuilder.setSeverity(any())).thenReturn(logRecordBuilder);
        when(logRecordBuilder.setBody(anyString())).thenReturn(logRecordBuilder);
        when(logRecordBuilder.setAllAttributes(any())).thenReturn(logRecordBuilder);

        // Create channel and flow
        producerChannel = new DirectChannel();
        
        // Create flow directly using the handler logic (not the full config to avoid SDK beans)
        flow = IntegrationFlow.from(producerChannel)
                .handle((payload, headers) -> {
                    String json = (payload instanceof String s) ? s : String.valueOf(payload);

                    Attributes attrs = Attributes.builder()
                            .put(io.opentelemetry.api.common.AttributeKey.stringKey("source"), "solace-syslog")
                            .put(io.opentelemetry.api.common.AttributeKey.stringKey("format"), "json")
                            .build();

                    otelLogger.logRecordBuilder()
                            .setSeverity(Severity.INFO)
                            .setBody(json)
                            .setAllAttributes(attrs)
                            .emit();

                    return null;
                })
                .get();

        // Start the flow
        ((StandardIntegrationFlow) flow).start();
    }

    @Test
    @DisplayName("Should emit LogRecord with JSON body when String payload sent")
    void shouldEmitLogRecordWithJsonBody() {
        // Given
        String jsonPayload = "{\"timestamp\":\"2024-01-15T10:30:00Z\",\"message\":\"Test\"}";

        // When
        producerChannel.send(MessageBuilder.withPayload(jsonPayload).build());

        // Then
        verify(otelLogger).logRecordBuilder();
        verify(logRecordBuilder).setBody(bodyCaptor.capture());
        verify(logRecordBuilder).emit();

        assertThat(bodyCaptor.getValue()).isEqualTo(jsonPayload);
    }

    @Test
    @DisplayName("Should set severity to INFO")
    void shouldSetSeverityToInfo() {
        // Given
        String jsonPayload = "{\"test\":\"data\"}";

        // When
        producerChannel.send(MessageBuilder.withPayload(jsonPayload).build());

        // Then
        verify(logRecordBuilder).setSeverity(severityCaptor.capture());
        assertThat(severityCaptor.getValue()).isEqualTo(Severity.INFO);
    }

    @Test
    @DisplayName("Should set correct attributes")
    void shouldSetCorrectAttributes() {
        // Given
        String jsonPayload = "{\"test\":\"data\"}";

        // When
        producerChannel.send(MessageBuilder.withPayload(jsonPayload).build());

        // Then
        verify(logRecordBuilder).setAllAttributes(attributesCaptor.capture());
        Attributes attrs = attributesCaptor.getValue();

        assertThat(attrs.get(io.opentelemetry.api.common.AttributeKey.stringKey("source")))
                .isEqualTo("solace-syslog");
        assertThat(attrs.get(io.opentelemetry.api.common.AttributeKey.stringKey("format")))
                .isEqualTo("json");
    }

    @Test
    @DisplayName("Should convert non-String payload to String")
    void shouldConvertNonStringPayload() {
        // Given
        TestPayload payload = new TestPayload("test-value");

        // When
        producerChannel.send(MessageBuilder.withPayload(payload).build());

        // Then
        verify(logRecordBuilder).setBody(bodyCaptor.capture());
        assertThat(bodyCaptor.getValue()).isEqualTo("TestPayload[value=test-value]");
    }

    @Test
    @DisplayName("Should handle multiple messages")
    void shouldHandleMultipleMessages() {
        // Given
        String json1 = "{\"id\":1}";
        String json2 = "{\"id\":2}";
        String json3 = "{\"id\":3}";

        // When
        producerChannel.send(MessageBuilder.withPayload(json1).build());
        producerChannel.send(MessageBuilder.withPayload(json2).build());
        producerChannel.send(MessageBuilder.withPayload(json3).build());

        // Then
        verify(otelLogger, times(3)).logRecordBuilder();
        verify(logRecordBuilder, times(3)).emit();
    }

    @Test
    @DisplayName("Should handle empty JSON")
    void shouldHandleEmptyJson() {
        // Given
        String emptyJson = "{}";

        // When
        producerChannel.send(MessageBuilder.withPayload(emptyJson).build());

        // Then
        verify(logRecordBuilder).setBody("{}");
        verify(logRecordBuilder).emit();
    }

    // Test helper
    record TestPayload(String value) {
        @Override
        public String toString() {
            return "TestPayload[value=" + value + "]";
        }
    }
}
