[Unit]
Description=cAdvisor Podman metrics exporter
Documentation=https://github.com/google/cadvisor
After=network.target
# If you have a specific podman socket service that must be available first, add:
# Requires=podman.socket
# After=podman.socket network.target

[Service]
Type=simple
Restart=always
RestartSec=10s
StartLimitIntervalSec=60
StartLimitBurst=3

# Generate environment file with dynamic UID/GID for the service user
ExecStartPre=/bin/bash -c '\
  echo "USER_ID=$(id -u {{solace_local_service_user}})" > /home/{{solace_local_service_user}}/etc_solace/solace-user.conf && \
  echo "GROUP_ID=$(id -g {{solace_local_service_user}})" >> /home/{{solace_local_service_user}}/etc_solace/solace-user.conf \
'
ExecStartPre=/bin/test -f /home/{{solace_local_service_user}}/etc_solace/solace-user.conf

# Load environment with USER_ID and GROUP_ID
EnvironmentFile=/home/{{solace_local_service_user}}/etc_solace/solace-user.conf

# Direct execution of cAdvisor binary with connection to Podman socket
ExecStart={{cadvisor_path}} --podman "unix://{{podman_socket_path}}"

# Resource limits to prevent excessive resource consumption
MemoryLimit=1G
CPUQuota=200%

# Security hardening options
ProtectSystem=full
PrivateTmp=true
NoNewPrivileges=true

# Output logs to journald for easy access with journalctl
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
