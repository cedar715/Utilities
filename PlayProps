{{- if .Values.syslogCollector.enabled -}}
{{- range $i := until (int .Values.syslogCollector.instances) -}}
{{- $instanceIndex := add $i 1 -}}
{{- $instanceName := include "syslog-collector.instanceName" $instanceIndex -}}
{{- $instancePort := include "syslog-collector.instancePort" $instanceIndex -}}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ $instanceName }}
  labels:
    {{- include "syslog-collector.labels" $instanceIndex | nindent 4 }}
spec:
  replicas: 1  # Each deployment has exactly 1 replica
  selector:
    matchLabels:
      {{- include "syslog-collector.selectorLabels" $instanceIndex | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "syslog-collector.selectorLabels" $instanceIndex | nindent 8 }}
      annotations:
        {{- with $.Values.syslogCollector.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        {{- range $.Values.syslogCollector.instanceOverrides }}
        {{- if eq (int .instanceIndex) $instanceIndex }}
        {{- with .annotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        {{- end }}
        {{- end }}
    spec:
      {{- with $.Values.syslogCollector.securityContext }}
      securityContext:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: {{ $instanceName }}
          image: "{{ $.Values.global.image.repository }}:{{ $.Values.global.image.tag }}"
          imagePullPolicy: {{ $.Values.global.image.pullPolicy }}
          ports:
            - name: syslog
              containerPort: {{ $instancePort }}
              protocol: UDP
            - name: syslog-tcp
              containerPort: {{ $instancePort }}
              protocol: TCP
            - name: metrics
              containerPort: 9102
              protocol: TCP
          env:
            - name: SYSLOG_PORT
              value: "{{ $instancePort }}"
            - name: INSTANCE_NAME
              value: "{{ $instanceName }}"
            - name: SOLACE_HA_INSTANCE
              value: "{{ $instanceIndex }}"
            {{- range $.Values.syslogCollector.instanceOverrides }}
            {{- if eq (int .instanceIndex) $instanceIndex }}
            {{- with .env }}
            {{- toYaml . | nindent 12 }}
            {{- end }}
            {{- end }}
            {{- end }}
          resources:
            {{- include "syslog-collector.resources" $instanceIndex | nindent 12 }}
          {{- with $.Values.syslogCollector.containerConfig }}
          {{- toYaml . | nindent 10 }}
          {{- end }}
          volumeMounts:
            - name: secrets
              mountPath: {{ $.Values.syslogCollector.secretVolume.mountPath }}
              readOnly: true
      volumes:
        - name: secrets
          secret:
            secretName: {{ $.Values.syslogCollector.secretVolume.name }}
{{- end }}
{{- end }}
