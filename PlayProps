---
---
# test-cns.yaml
- name: Test CN generation for observability components
  hosts: localhost
  gather_facts: false
  
  vars:
    domain_suffix: "example.com"
    components:
      - grafana
      - prometheus
      - jaeger
      - alertmanager
      - node-exporter

  tasks:
    - name: Generate CN list
      set_fact:
        cert_common_names: "{{ components | map('regex_replace', '^(.*)$', '\\1.' + domain_suffix) | list }}"

    - name: Display generated CNs
      debug:
        msg: "Generated CNs:"
        verbosity: 0

    - name: List all CNs
      debug:
        msg: "- {{ item }}"
      loop: "{{ cert_common_names }}"
      loop_control:
        label: "{{ item }}"

# site-observability.yaml
- name: Generate certificates for observability components
  hosts: localhost
  gather_facts: false
  
  vars:
    domain_suffix: "example.com"  # Change to your domain
    components:
      - grafana
      - prometheus
      - jaeger
      - alertmanager
      - node-exporter

  pre_tasks:
    - name: Generate CN list for certificates
      set_fact:
        cert_common_names: "{{ components | map('regex_replace', '^(.*)$', '\\1.' + domain_suffix) | list }}"

  roles:
    - role: your-cert-generation-role  # Replace with your actual role name
      vars:
        common_names: "{{ cert_common_names }}"
        # Add any other variables your cert generation role expects
        # For example:
        # cert_path: "/path/to/certs"
        # cert_owner: "cert-user"
        # cert_validity_days: 365

  post_tasks:
    - name: Display generated certificate details
      debug:
        msg: "Generated certificates for {{ cert_common_names | join(', ') }}"
